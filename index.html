<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <!-- PWA 全屏设置 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>AI Social App</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            /* 修改主题为黑色 */
            --primary-color: #1a1a1a; 
            --bg-color: #Fdfdfd;
            --text-main: #333333;
            --text-sub: #888888;
            --border-radius: 16px;
            --capsule-radius: 50px;
            --shadow-soft: 0 4px 20px rgba(0,0,0,0.05);
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --user-bubble-color: #E0FFFF; /* 浅青色 */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background-color: #f5f6fa; font-family: var(--font-family); color: var(--text-main); height: 100vh; overflow: hidden; }
        
        /* 通用类 */
        .hidden { display: none !important; }
        .page { height: calc(100vh - 80px); overflow-y: auto; padding-bottom: 20px; position: relative; } 
        
        /* 独立页面：层级极高，覆盖底栏 */
        .full-page { height: 100vh; background: #f5f6fa; overflow-y: auto; position: fixed; top: 0; left: 0; width: 100%; z-index: 2000; transform: translateX(100%); transition: 0.3s; padding-bottom: env(safe-area-inset-bottom); }
        .full-page.open { transform: translateX(0); }

        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: var(--bg-color); position: sticky; top: 0; z-index: 100; font-weight: 700; font-size: 18px; box-shadow: 0 2px 10px rgba(0,0,0,0.02); padding-top: calc(15px + env(safe-area-inset-top)); }
        .btn-icon { background: none; border: none; font-size: 20px; color: var(--text-main); cursor: pointer; padding: 5px; }
        
        /* 底部导航 */
        .navbar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; align-items: flex-start; border-top: 1px solid #eee; z-index: 1000; 
            height: calc(65px + env(safe-area-inset-bottom)); 
            padding-bottom: env(safe-area-inset-bottom); 
            padding-top: 12px;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #ccc; font-size: 12px; transition: 0.3s; }
        .nav-item i { font-size: 22px; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary-color); transform: translateY(-2px); }

        /* 胶囊样式 (世界书) */
        .capsule { display: inline-block; padding: 6px 12px; border-radius: var(--capsule-radius); background: #f0f2f5; font-size: 12px; margin-right: 8px; margin-bottom: 8px; color: var(--text-sub); border: 1px solid transparent; transition: 0.2s; cursor: pointer; }
        .capsule.active { background: #eef0ff; color: var(--primary-color); border-color: var(--primary-color); }
        
        /* 世界书分组样式 (白色条目) */
        .wi-group-item { background: white; padding: 10px 15px; border-radius: 8px; margin-bottom: 8px; font-size: 14px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .wi-group-item:active { background: #f9f9f9; }

        /* 聊天列表页 */
        .chat-item { display: flex; padding: 15px 20px; background: white; margin-bottom: 1px; align-items: center; cursor: pointer; }
        .chat-item:active { background: #f9f9f9; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background: #eee; flex-shrink: 0; }
        .chat-info { margin-left: 15px; flex: 1; }
        .chat-name { font-weight: 600; font-size: 16px; margin-bottom: 4px; }
        .chat-preview { font-size: 13px; color: var(--text-sub); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px; }

        /* 聊天窗口 */
        #chat-window { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f5f6fa; z-index: 1200; display: flex; flex-direction: column; transform: translateX(100%); transition: 0.3s; }
        #chat-window.open { transform: translateX(0); }
        .chat-header-center { flex: 1; text-align: center; margin-right: 20px; font-weight: bold; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; padding-bottom: 20px; }
        
        .msg-row { display: flex; max-width: 80%; }
        .msg-row.user { align-self: flex-end; flex-direction: row-reverse; }
        .msg-bubble { padding: 10px 15px; border-radius: 18px; font-size: 15px; line-height: 1.5; position: relative; word-wrap: break-word; user-select: none; } 
        .msg-row.ai .msg-bubble { background: white; border-top-left-radius: 2px; color: #333; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg-row.user .msg-bubble { background: var(--user-bubble-color); border-top-right-radius: 2px; color: #333; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg-row.user .avatar { width: 35px; height: 35px; margin-left: 10px; border-radius: 50%; }

        /* 特殊消息样式 */
        .msg-bubble.revoked { background: rgba(255,255,255,0.6) !important; color: #999 !important; border: 1px dashed #ccc; box-shadow: none !important; cursor: pointer; font-size: 13px; font-style: italic; }
        .msg-bubble.transfer { background: #fa9d3b !important; color: white !important; width: 220px; padding: 15px; display: flex; flex-direction: column; }
        .transfer-icon { font-size: 24px; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; }
        .transfer-amount { font-size: 20px; font-weight: bold; }

        .quote-container { background: #f2f2f2; padding: 8px; border-radius: 8px; font-size: 12px; color: #666; margin: 0 10px 10px 10px; border-left: 3px solid var(--primary-color); display: none; }
        .quote-container.show { display: block; }
        
        /* 聊天底部栏 */
        .chat-bottom-bar { background: white; border-top: 1px solid #eee; display: flex; flex-direction: column; padding-bottom: env(safe-area-inset-bottom); }
        .chat-input-row { display: flex; align-items: center; padding: 10px; gap: 10px; }
        .chat-input { flex: 1; border: none; background: #f0f2f5; padding: 12px 15px; border-radius: 20px; outline: none; max-height: 100px; resize: none; font-size: 15px; }
        .btn-circle-send { width: 40px; height: 40px; border-radius: 50%; background: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: 0.1s; }
        .btn-circle-send:active { transform: scale(0.90); }
        
        /* 扩展面板 */
        .expand-panel { height: 0; overflow: hidden; transition: 0.3s; background: #f8f8f8; display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 0 10px; border-top: 1px solid #eee; }
        .expand-panel.show { height: 100px; padding: 20px 10px; }
        .expand-item { display: flex; flex-direction: column; align-items: center; font-size: 12px; color: #666; cursor: pointer; }
        .expand-icon-box { width: 45px; height: 45px; background: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 5px; font-size: 20px; color: #555; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* 通讯录页 */
        .contact-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px; padding: 10px; }
        .contact-card { background: white; padding: 15px; border-radius: var(--border-radius); display: flex; align-items: center; box-shadow: var(--shadow-soft); position: relative; user-select: none; transition: 0.2s; }
        .contact-card:active { transform: scale(0.98); }
        .contact-info { margin-left: 15px; flex: 1; }
        .contact-tag { font-size: 10px; background: #f0f2f5; padding: 2px 6px; border-radius: 4px; color: #666; margin-top: 5px; display: inline-block; }

        /* 朋友圈页 */
        .moments-header { position: relative; height: 260px; margin-bottom: 40px; }
        .moments-bg { width: 100%; height: 100%; object-fit: cover; cursor: pointer; }
        .moments-avatar { position: absolute; right: 20px; bottom: -30px; width: 80px; height: 80px; border-radius: 50%; border: 3px solid white; object-fit: cover; background: #ddd; cursor: pointer; }
        .moments-user-name { position: absolute; right: 110px; bottom: 10px; color: white; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.5); font-size: 18px; }
        .post-card { background: white; padding: 20px; margin-bottom: 10px; border-bottom: 1px solid #f0f0f0; }
        .post-header { display: flex; margin-bottom: 10px; }
        .post-content { margin-left: 50px; }
        .post-text { font-size: 15px; line-height: 1.5; margin-bottom: 10px; }
        .post-actions { display: flex; justify-content: space-between; margin-top: 10px; color: #666; font-size: 13px; }
        .post-comments { background: #f9f9f9; padding: 10px; margin-top: 10px; border-radius: 8px; font-size: 13px; }
        .comment-item { padding: 3px 0; }
        .comment-item:active { background: #eee; }
        .fa-heart.liked { color: #ff6b6b; } 

        /* 我的页 */
        .profile-header { text-align: center; padding: 40px 20px; background: white; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; box-shadow: var(--shadow-soft); margin-bottom: 20px; }
        .profile-avatar { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 15px; border: 4px solid #f0f2f5; cursor: pointer; }
        .profile-name-input { border: none; border-bottom: 1px solid #ccc; font-size: 20px; font-weight: bold; text-align: center; width: 150px; outline: none; margin-bottom: 20px; background: transparent; }
        
        .profile-actions { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;}
        .action-btn { display: flex; flex-direction: column; align-items: center; cursor: pointer; width: 60px; }
        .action-icon { width: 50px; height: 50px; background: #eef0ff; color: var(--primary-color); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-bottom: 5px; }

        .settings-group { background: white; margin: 15px; padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow-soft); }
        .group-title { font-weight: 700; margin-bottom: 15px; font-size: 16px; border-left: 4px solid var(--primary-color); padding-left: 10px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 12px; color: var(--text-sub); margin-bottom: 5px; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #eee; border-radius: 8px; font-family: inherit; outline: none; transition: 0.3s; }
        .form-input:focus { border-color: var(--primary-color); }
        .btn-primary { width: 100%; padding: 12px; background: var(--primary-color); color: white; border: none; border-radius: 30px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

        /* 钱包页面样式 */
        .wallet-carousel { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; gap: 15px; padding: 20px; -webkit-overflow-scrolling: touch; }
        .bank-card { flex-shrink: 0; width: 300px; height: 180px; background: linear-gradient(135deg, #222 0%, #444 100%); background-size: cover; background-position: center; border-radius: 20px; scroll-snap-align: center; color: white; padding: 25px; position: relative; box-shadow: 0 10px 20px rgba(0,0,0,0.2); display: flex; flex-direction: column; justify-content: space-between; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }
        .card-chip { width: 40px; height: 30px; background: #e0e0e0; border-radius: 5px; margin-bottom: 10px; opacity: 0.8; }
        .card-number { font-size: 22px; letter-spacing: 2px; }
        .card-info { display: flex; justify-content: space-between; align-items: flex-end; }
        .card-balance { font-size: 24px; font-weight: bold; }
        .transaction-list { padding: 0 20px; }
        .trans-item { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #f0f0f0; }
        .trans-info div:first-child { font-weight: 600; margin-bottom: 4px; }
        .trans-info div:last-child { font-size: 12px; color: #999; }
        .trans-amount { font-weight: bold; }

        /* 表情包页面样式 */
        .sticker-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px; }
        .sticker-item { aspect-ratio: 1; background: white; border-radius: 10px; overflow: hidden; position: relative; box-shadow: var(--shadow-soft); }
        .sticker-item img { width: 100%; height: 100%; object-fit: cover; }
        .sticker-desc { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.5); color: white; font-size: 10px; padding: 3px; text-align: center; }

        /* 弹窗 */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; }
        .modal.show { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; width: 85%; max-width: 400px; padding: 25px; border-radius: 20px; max-height: 80vh; overflow-y: auto; }
        .modal-title { font-size: 18px; font-weight: bold; margin-bottom: 20px; text-align: center; }
        
        .img-preview-box { width: 100px; height: 100px; border-radius: 10px; background: #f0f0f0; margin-top: 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; }
        .img-preview-box img { width: 100%; height: 100%; object-fit: cover; }

        /* 长按菜单 (Action Sheet) */
        .action-sheet { position: fixed; bottom: 0; left: 0; width: 100%; background: white; z-index: 10001; border-top-left-radius: 20px; border-top-right-radius: 20px; transform: translateY(100%); transition: 0.3s; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); padding-bottom: env(safe-area-inset-bottom); }
        .action-sheet.show { transform: translateY(0); }
        .action-item { padding: 15px; text-align: center; border-bottom: 1px solid #eee; font-size: 16px; }
        .action-item:active { background: #f9f9f9; }
        .action-item.danger { color: #ff6b6b; }
        .action-cancel { padding: 15px; text-align: center; font-weight: bold; border-top: 5px solid #f5f6fa; }

    </style>
</head>
<body>

    <!-- 全局文件上传 Input -->
    <input type="file" id="global-file-input" accept="image/*" hidden>
    <input type="file" id="import-file-input" accept=".json" hidden>

    <!-- 遮罩层 (用于关闭 Action Sheet) -->
    <div id="overlay-mask" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9000;display:none;" onclick="closeAllActionSheets()"></div>

    <!-- Tab 1: 聊天 -->
    <div id="tab-chat" class="page">
        <div class="header">
            <span>消息</span>
        </div>
        <div id="chat-list-container">
            <!-- 动态生成 -->
            <div style="text-align:center; padding: 50px; color:#aaa; font-size:14px;">暂无聊天</div>
        </div>
    </div>

    <!-- Tab 2: 通讯录 -->
    <div id="tab-contacts" class="page hidden">
        <div class="header">
            <span>通讯录</span>
            <button class="btn-icon" onclick="openAddCharacterModal()"><i class="fas fa-plus"></i></button>
        </div>
        <div id="contacts-container" class="contact-grid">
            <!-- 动态生成 -->
        </div>
    </div>

    <!-- Tab 3: 朋友圈 -->
    <div id="tab-moments" class="page hidden">
        <div class="header" style="position: absolute; width: 100%; background: transparent; box-shadow: none; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">
            <span>朋友圈</span>
            <button class="btn-icon" style="color: white;" onclick="openPostModal()"><i class="fas fa-camera"></i></button>
        </div>
        <div class="moments-header">
            <img id="moments-bg-img" src="https://images.unsplash.com/photo-1579546929518-9e396f3cc809?w=800" class="moments-bg" onclick="triggerFileUpload('bg')">
            <span class="moments-user-name" id="moments-name-display">我</span>
            <img id="moments-avatar-img" src="https://ui-avatars.com/api/?name=Me&background=random" class="moments-avatar" onclick="triggerFileUpload('my-avatar')">
        </div>
        <div id="moments-feed">
            <!-- 动态生成 -->
        </div>
    </div>

    <!-- Tab 4: 我的 -->
    <div id="tab-profile" class="page hidden">
        <div class="profile-header">
            <img id="profile-avatar-img" src="https://ui-avatars.com/api/?name=User&background=1a1a1a&color=fff" class="profile-avatar" onclick="triggerFileUpload('my-avatar')">
            <div>
                <input type="text" id="profile-name-input" class="profile-name-input" value="User" onblur="saveUserName()">
            </div>
            
            <div class="profile-actions">
                <div class="action-btn" onclick="openStickersPage()">
                    <div class="action-icon"><i class="far fa-smile"></i></div>
                    <span style="font-size:12px;">表情包</span>
                </div>
                <div class="action-btn" onclick="openWalletPage()">
                    <div class="action-icon"><i class="fas fa-wallet"></i></div>
                    <span style="font-size:12px;">钱包</span>
                </div>
                <div class="action-btn" onclick="openBeautifyModal()">
                    <div class="action-icon"><i class="fas fa-paint-brush"></i></div>
                    <span style="font-size:12px;">美化</span>
                </div>
                <div class="action-btn" onclick="openBackupModal()">
                    <div class="action-icon"><i class="fas fa-save"></i></div>
                    <span style="font-size:12px;">备份</span>
                </div>
            </div>
        </div>

        <div class="settings-group">
            <div class="group-title">API 设置</div>
            <div class="input-group">
                <label>反代地址 (Base URL)</label>
                <input type="text" id="api-url" class="form-input" placeholder="例如: https://api.openai.com/v1">
            </div>
            <div class="input-group">
                <label>API Key</label>
                <input type="password" id="api-key" class="form-input" placeholder="sk-...">
            </div>
            <button class="btn-primary" onclick="fetchModels()" style="margin-bottom: 10px;">拉取模型列表</button>
            <div class="input-group">
                <label>选择模型</label>
                <select id="model-select" class="form-input">
                    <option value="gpt-3.5-turbo">gpt-3.5-turbo (默认)</option>
                </select>
            </div>
        </div>

        <div class="settings-group">
            <div class="header" style="padding:0; box-shadow:none; margin-bottom:15px; background:none;">
                <div class="group-title" style="margin:0;">世界书 (World Info)</div>
                <button class="btn-icon" onclick="openWorldInfoModal()"><i class="fas fa-plus"></i></button>
            </div>
            <div id="world-info-list" style="display: flex; flex-direction: column;">
                <!-- 动态生成 -->
            </div>
        </div>
    </div>

    <!-- 底部导航 -->
    <div class="navbar">
        <div class="nav-item active" onclick="switchTab('chat')">
            <i class="far fa-comment"></i>
            <span>聊天</span>
        </div>
        <div class="nav-item" onclick="switchTab('contacts')">
            <i class="far fa-address-book"></i>
            <span>通讯录</span>
        </div>
        <div class="nav-item" onclick="switchTab('moments')">
            <i class="far fa-compass"></i>
            <span>朋友圈</span>
        </div>
        <div class="nav-item" onclick="switchTab('profile')">
            <i class="far fa-user"></i>
            <span>我的</span>
        </div>
    </div>

    <!-- 独立页面：表情包 -->
    <div id="page-stickers" class="full-page">
        <div class="header">
            <button class="btn-icon" onclick="closeFullPage('page-stickers')"><i class="fas fa-chevron-left"></i></button>
            <span>表情包</span>
            <button class="btn-icon" onclick="document.getElementById('modal-sticker-add').classList.add('show')"><i class="fas fa-plus"></i></button>
        </div>
        <div id="stickers-container" class="sticker-grid"></div>
    </div>

    <!-- 独立页面：钱包 -->
    <div id="page-wallet" class="full-page">
        <div class="header">
            <button class="btn-icon" onclick="closeFullPage('page-wallet')"><i class="fas fa-chevron-left"></i></button>
            <span>钱包</span>
            <button class="btn-icon" onclick="document.getElementById('modal-card-add').classList.add('show')"><i class="fas fa-plus"></i></button>
        </div>
        <div id="wallet-cards-container" class="wallet-carousel">
            <!-- 银行卡 -->
        </div>
        <div style="padding: 10px 20px; font-weight: bold; color: #555;">消费记录</div>
        <div id="wallet-transactions" class="transaction-list">
            <!-- 记录 -->
        </div>
    </div>

    <!-- 聊天窗口 (新版) -->
    <div id="chat-window">
        <div class="header">
            <button class="btn-icon" onclick="closeChatWindow()"><i class="fas fa-chevron-left"></i></button>
            <div class="chat-header-center" id="current-chat-title">名字</div>
            <div style="width:30px;"></div>
        </div>
        <div class="chat-messages" id="current-chat-messages">
            <!-- 消息 -->
        </div>
        <div class="chat-bottom-bar">
            <!-- 引用框 -->
            <div id="quote-preview" class="quote-container">
                <div>回复: <span id="quote-text">...</span></div>
                <div style="text-align:right; color:var(--primary-color);" onclick="cancelQuote()">取消</div>
            </div>

            <div class="chat-input-row">
                <button class="btn-icon" onclick="toggleExpandPanel()"><i class="fas fa-plus-circle" style="color:#7F7FD5;"></i></button>
                <textarea id="msg-input" class="chat-input" rows="1" placeholder="发送消息..."></textarea>
                <!-- 发送按钮：单击发送，双击AI回复 -->
                <button id="btn-send-trigger" class="btn-circle-send"><i class="fas fa-arrow-up"></i></button>
            </div>
            <!-- 扩展面板 -->
            <div id="expand-panel" class="expand-panel">
                <div class="expand-item">
                    <div class="expand-icon-box"><i class="fas fa-microphone"></i></div>
                    <span>语音</span>
                </div>
                <div class="expand-item">
                    <div class="expand-icon-box"><i class="fas fa-image"></i></div>
                    <span>照片</span>
                </div>
                <div class="expand-item" onclick="openTransferModal()">
                    <div class="expand-icon-box"><i class="fas fa-exchange-alt"></i></div>
                    <span>转账</span>
                </div>
                <div class="expand-item">
                    <div class="expand-icon-box"><i class="fas fa-gift"></i></div>
                    <span>礼物</span>
                </div>
                <div class="expand-item">
                    <div class="expand-icon-box"><i class="fas fa-hamburger"></i></div>
                    <span>外卖</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 菜单：聊天消息双击 -->
    <div id="sheet-msg-actions" class="action-sheet">
        <div class="action-item" onclick="msgAction('edit')">编辑</div>
        <div class="action-item" onclick="msgAction('delete')">删除</div>
        <div class="action-item" onclick="msgAction('revoke')">撤回</div>
        <div class="action-item" onclick="msgAction('quote')">引用</div>
        <div id="action-regenerate" class="action-item" onclick="msgAction('regenerate')">重回 (重新生成)</div>
        <div class="action-cancel" onclick="closeAllActionSheets()">取消</div>
    </div>

    <!-- 菜单：钱包卡片双击 -->
    <div id="sheet-card-actions" class="action-sheet">
        <div class="action-item" onclick="cardAction('recharge')">充值</div>
        <div class="action-item danger" onclick="cardAction('delete')">删除</div>
        <div class="action-cancel" onclick="closeAllActionSheets()">取消</div>
    </div>

    <!-- 弹窗：美化 -->
    <div id="modal-beautify" class="modal">
        <div class="modal-content">
            <div class="modal-title" style="display:flex; justify-content:space-between; align-items:center;">
                <span>美化 CSS</span>
                <button class="btn-primary" style="width:auto; padding:5px 10px; font-size:12px;" onclick="fetchCSS()">拉取代码</button>
            </div>
            <textarea id="css-input" class="form-input" rows="10" placeholder="/* 在此处输入CSS */"></textarea>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-primary" onclick="alert('暂未实现动态注入，仅供展示'); closeModal('modal-beautify')">应用</button>
                <button class="btn-primary" style="background:#ff6b6b;" onclick="closeModal('modal-beautify')">关闭</button>
            </div>
        </div>
    </div>

    <!-- 弹窗：备份 -->
    <div id="modal-backup" class="modal">
        <div class="modal-content">
            <div class="modal-title">数据备份</div>
            <div style="display:flex; gap:10px; flex-direction:column;">
                <button class="btn-primary" onclick="exportData()">导出数据 (JSON)</button>
                <button class="btn-primary" style="background:#555;" onclick="document.getElementById('import-file-input').click()">导入数据 (JSON)</button>
                <button class="btn-primary" style="background:#ff6b6b;" onclick="closeModal('modal-backup')">关闭</button>
            </div>
        </div>
    </div>

    <!-- 弹窗：世界书分组详情 -->
    <div id="modal-wi-group-view" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="wi-group-title">分组详情</div>
            <div id="wi-group-list" style="max-height: 300px; overflow-y:auto; display:flex; flex-wrap:wrap;"></div>
            <div style="margin-top:10px; text-align:center;">
                <button class="btn-primary" onclick="closeModal('modal-wi-group-view')">关闭</button>
            </div>
        </div>
    </div>

    <!-- 弹窗：转账 -->
    <div id="modal-transfer" class="modal">
        <div class="modal-content">
            <div class="modal-title">转账</div>
            <div class="input-group">
                <label>选择付款卡片</label>
                <select id="transfer-card-select" class="form-input"></select>
            </div>
            <div class="input-group">
                <label>金额</label>
                <input type="number" id="transfer-amount" class="form-input" placeholder="0.00">
            </div>
            <div class="input-group">
                <label>支付密码</label>
                <input type="password" id="transfer-pass" class="form-input" placeholder="******">
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-primary" onclick="confirmTransfer()">确认转账</button>
                <button class="btn-primary" style="background:#ff6b6b;" onclick="closeModal('modal-transfer')">取消</button>
            </div>
        </div>
    </div>

    <!-- 弹窗：添加/编辑角色 -->
    <div id="modal-character" class="modal">
        <div class="modal-content">
            <div class="modal-title">角色信息</div>
            <input type="hidden" id="char-id">
            <div class="input-group">
                <label>头像 (点击上传)</label>
                <div class="img-preview-box" onclick="triggerFileUpload('char-avatar-modal')">
                    <img id="char-avatar-preview" src="https://ui-avatars.com/api/?background=random">
                </div>
            </div>
            <div class="input-group">
                <label>名字</label>
                <input type="text" id="char-name" class="form-input">
            </div>
            <div class="input-group">
                <label>人设 (Prompt)</label>
                <textarea id="char-prompt" class="form-input" rows="4"></textarea>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-primary" onclick="saveCharacter()">保存</button>
                <button class="btn-primary" style="background:#ff6b6b;" onclick="closeModal('modal-character')">取消</button>
            </div>
        </div>
    </div>

    <!-- 弹窗：添加表情包 -->
    <div id="modal-sticker-add" class="modal">
        <div class="modal-content">
            <div class="modal-title">添加表情包</div>
            <div class="input-group">
                <label>格式: 描述:URL链接 (换行添加多个)</label>
                <textarea id="sticker-input-str" class="form-input" rows="5" placeholder="开心:https://...&#10;难过:https://..."></textarea>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-primary" onclick="addSticker()">添加</button>
                <button class="btn-primary" style="background:#ff6b6b;" onclick="closeModal('modal-sticker-add')">取消</button>
            </div>
        </div>
    </div>

    <!-- 弹窗：添加银行卡 -->
    <div id="modal-card-add" class="modal">
        <div class="modal-content">
            <div class="modal-title">添加卡片</div>
            <div class="input-group">
                <label>卡面图片 (点击上传或输入URL)</label>
                <div class="img-preview-box" style="width:100%; height:80px; margin-bottom:5px;" onclick="triggerFileUpload('card-img-modal')">
                    <img id="card-img-preview" style="display:none; width:100%; height:100%; object-fit:cover;">
                    <span id="card-img-placeholder" style="color:#aaa;">点击选择图片</span>
                </div>
                <input type="text" id="card-img-url" class="form-input" placeholder="或输入图片URL" onchange="document.getElementById('card-img-preview').src=this.value;document.getElementById('card-img-preview').style.display='block';">
                <input type="hidden" id="card-img-base64">
            </div>
            <div class="input-group">
                <label>卡号 (19位)</label>
                <input type="text" id="card-no" class="form-input" maxlength="19" placeholder="xxxx xxxx xxxx xxxx">
            </div>
            <div class="input-group">
                <label>密码</label>
                <input type="password" id="card-pass" class="form-input" placeholder="******">
            </div>
            <div class="input-group">
                <label>余额</label>
                <input type="number" id="card-balance" class="form-input" placeholder="0.00">
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-primary" onclick="addCard()">添加</button>
                <button class="btn-primary" style="background:#ff6b6b;" onclick="closeModal('modal-card-add')">取消</button>
            </div>
        </div>
    </div>

    <!-- 弹窗：添加世界书 -->
    <div id="modal-worldinfo" class="modal">
        <div class="modal-content">
            <div class="modal-title">世界书条目</div>
            <div class="input-group">
                <label>分组名称 (选填)</label>
                <input type="text" id="wi-group" class="form-input" placeholder="例如: 魔法、地理">
            </div>
            <div class="input-group">
                <label>关键词 (触发词)</label>
                <input type="text" id="wi-keyword" class="form-input" placeholder="例如: 火球术">
            </div>
            <div class="input-group">
                <label>内容</label>
                <textarea id="wi-content" class="form-input" rows="3" placeholder="世界观描述..."></textarea>
            </div>
            <div class="input-group">
                <label>生效范围</label>
                <select id="wi-scope" class="form-input">
                    <option value="global">全局 (所有角色)</option>
                </select>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-primary" onclick="saveWorldInfo()">添加</button>
                <button class="btn-primary" style="background:#ff6b6b;" onclick="closeModal('modal-worldinfo')">取消</button>
            </div>
        </div>
    </div>

    <!-- 弹窗：发朋友圈 -->
    <div id="modal-post" class="modal">
        <div class="modal-content">
            <div class="modal-title">发布动态</div>
            <textarea id="post-content" class="form-input" rows="4" placeholder="分享你的想法..."></textarea>
            <div class="input-group">
                <label>配图 (点击上传，可选)</label>
                <div class="img-preview-box" style="width:100%; height:150px;" onclick="triggerFileUpload('post-img-modal')">
                    <img id="post-img-preview" src="" style="display:none;">
                    <span id="post-img-placeholder" style="color:#aaa;">点击选择图片</span>
                </div>
                <input type="hidden" id="post-img-base64">
            </div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-primary" onclick="publishPost()">发布</button>
                <button class="btn-primary" style="background:#ff6b6b;" onclick="closeModal('modal-post')">取消</button>
            </div>
        </div>
    </div>

    <script>
        // --- 数据管理 ---
        const store = {
            get(key, def) { 
                try {
                    const v = localStorage.getItem(key); 
                    return v ? JSON.parse(v) : def; 
                } catch(e) { return def; }
            },
            set(key, val) { 
                try {
                    localStorage.setItem(key, JSON.stringify(val)); 
                } catch(e) { alert("存储空间已满"); }
            }
        };

        let state = {
            user: store.get('user', { name: 'User' }),
            characters: store.get('chars', []), 
            chats: store.get('chats', {}), 
            posts: store.get('posts', []), 
            stickers: store.get('stickers', []),
            wallet: store.get('wallet', []), 
            config: store.get('config', { url: 'https://api.openai.com/v1', key: '', model: 'gpt-3.5-turbo', myAvatar: '', myBg: '' }),
            worldInfo: store.get('worldInfo', []) // {id, keyword, content, scope, group}
        };

        // --- 全局变量 ---
        let currentUploadTarget = null; 
        let longPressTimer;
        let activeMsgId = null; 
        let activeCardId = null; 
        let currentQuote = null;

        const fileInput = document.getElementById('global-file-input');
        const importInput = document.getElementById('import-file-input');

        function triggerFileUpload(target) {
            currentUploadTarget = target;
            fileInput.click();
        }

        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                const base64 = event.target.result;
                if(currentUploadTarget === 'my-avatar') {
                    document.getElementById('moments-avatar-img').src = base64;
                    document.getElementById('profile-avatar-img').src = base64;
                    state.config.myAvatar = base64;
                    store.set('config', state.config);
                } else if(currentUploadTarget === 'bg') {
                    document.getElementById('moments-bg-img').src = base64;
                    state.config.myBg = base64;
                    store.set('config', state.config);
                } else if(currentUploadTarget === 'char-avatar-modal') {
                    document.getElementById('char-avatar-preview').src = base64;
                } else if(currentUploadTarget === 'post-img-modal') {
                    document.getElementById('post-img-preview').src = base64;
                    document.getElementById('post-img-preview').style.display = 'block';
                    document.getElementById('post-img-placeholder').style.display = 'none';
                    document.getElementById('post-img-base64').value = base64;
                } else if(currentUploadTarget === 'card-img-modal') {
                    document.getElementById('card-img-preview').src = base64;
                    document.getElementById('card-img-preview').style.display = 'block';
                    document.getElementById('card-img-placeholder').style.display = 'none';
                    document.getElementById('card-img-base64').value = base64;
                }
            };
            reader.readAsDataURL(file);
            fileInput.value = ''; 
        });

        // 导入逻辑
        importInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const data = JSON.parse(event.target.result);
                    // 覆盖Local Storage
                    for (const key in data) {
                        localStorage.setItem(key, data[key]);
                    }
                    alert('导入成功，页面将刷新');
                    location.reload();
                } catch(e) {
                    alert('文件格式错误');
                }
            };
            reader.readAsText(file);
            importInput.value = '';
        });

        // --- 初始化 ---
        function init() {
            renderContacts();
            renderChatList();
            renderMoments();
            renderProfile();
            
            document.getElementById('api-url').value = state.config.url;
            document.getElementById('api-key').value = state.config.key;
            if(state.config.myAvatar) document.getElementById('moments-avatar-img').src = document.getElementById('profile-avatar-img').src = state.config.myAvatar;
            if(state.config.myBg) document.getElementById('moments-bg-img').src = state.config.myBg;
            document.getElementById('profile-name-input').value = state.user.name;
            document.getElementById('moments-name-display').innerText = state.user.name;
            
            const modelSelect = document.getElementById('model-select');
            if(state.config.modelList) {
                modelSelect.innerHTML = state.config.modelList.map(m => `<option value="${m}">${m}</option>`).join('');
                modelSelect.value = state.config.model;
            }

            // 发送按钮逻辑
            const sendBtn = document.getElementById('btn-send-trigger');
            let clickTimer = null;
            sendBtn.addEventListener('click', (e) => {
                if (clickTimer) {
                    clearTimeout(clickTimer);
                    clickTimer = null;
                    triggerAIResponse(); // 双击
                } else {
                    clickTimer = setTimeout(() => {
                        sendUserMessage(); // 单击
                        clickTimer = null;
                    }, 250); 
                }
            });
        }

        function switchTab(tabName) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById('tab-' + tabName).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            
            const navs = document.querySelectorAll('.nav-item');
            if(tabName === 'chat') navs[0].classList.add('active');
            if(tabName === 'contacts') navs[1].classList.add('active');
            if(tabName === 'moments') navs[2].classList.add('active');
            if(tabName === 'profile') navs[3].classList.add('active');
            
            if(tabName === 'chat') renderChatList();
            if(tabName === 'profile') renderWorldInfoList();
        }

        function renderProfile() {}
        function saveUserName() {
            const val = document.getElementById('profile-name-input').value;
            if(val) {
                state.user.name = val;
                store.set('user', state.user);
                document.getElementById('moments-name-display').innerText = val;
            }
        }

        // --- 美化与备份 ---
        function openBeautifyModal() { document.getElementById('modal-beautify').classList.add('show'); }
        function openBackupModal() { document.getElementById('modal-backup').classList.add('show'); }
        
        function fetchCSS() {
            const styles = document.getElementsByTagName('style');
            let cssText = '';
            for(let i=0; i<styles.length; i++) {
                cssText += styles[i].innerHTML + '\n';
            }
            document.getElementById('css-input').value = cssText;
        }

        function exportData() {
            const data = {};
            for(let i=0; i<localStorage.length; i++) {
                const key = localStorage.key(i);
                data[key] = localStorage.getItem(key);
            }
            const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'data.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // --- 表情包功能 ---
        function openStickersPage() {
            document.getElementById('page-stickers').classList.add('open');
            renderStickers();
        }
        function renderStickers() {
            const container = document.getElementById('stickers-container');
            container.innerHTML = state.stickers.map(s => `
                <div class="sticker-item">
                    <img src="${s.url}">
                    <div class="sticker-desc">${s.desc}</div>
                </div>
            `).join('');
        }
        function addSticker() {
            const textarea = document.getElementById('sticker-input-str').value;
            if(!textarea) return;
            const lines = textarea.split('\n');
            let addedCount = 0;
            lines.forEach(line => {
                line = line.trim();
                if(!line) return;
                const parts = line.split(/[:：]/);
                if(parts.length >= 2) {
                    const desc = parts[0];
                    const url = parts.slice(1).join(':'); 
                    state.stickers.push({ desc, url });
                    addedCount++;
                }
            });
            if(addedCount > 0) {
                store.set('stickers', state.stickers);
                closeModal('modal-sticker-add');
                document.getElementById('sticker-input-str').value = '';
                renderStickers();
            } else {
                alert('格式错误，请使用 描述:URL');
            }
        }

        // --- 钱包功能 ---
        function openWalletPage() {
            document.getElementById('page-wallet').classList.add('open');
            renderWallet();
        }
        function renderWallet() {
            const container = document.getElementById('wallet-cards-container');
            if(state.wallet.length === 0) {
                container.innerHTML = '<div style="text-align:center;width:100%;color:#aaa;padding-top:40px;">点击右上角添加卡片</div>';
                document.getElementById('wallet-transactions').innerHTML = '';
                return;
            }
            
            container.innerHTML = state.wallet.map(card => {
                const bgStyle = card.img ? `background-image: url('${card.img}');` : '';
                return `
                <div class="bank-card" style="${bgStyle}" onclick="handleCardClick(${card.id})" oncontextmenu="return false;">
                    <div style="text-align:right; font-size:12px;">Debit Card</div>
                    <div class="card-chip"></div>
                    <div class="card-number">${card.no.replace(/(.{4})/g, '$1 ')}</div>
                    <div class="card-info">
                        <div>
                            <div style="font-size:10px; opacity:0.8;">BALANCE</div>
                            <div class="card-balance">¥ ${parseFloat(card.bal).toFixed(2)}</div>
                        </div>
                        <div style="font-size:12px;">VIP</div>
                    </div>
                </div>
            `}).join('');
            
            if(activeCardId && state.wallet.find(c=>c.id === activeCardId)) {
                showTransactions(activeCardId);
            } else {
                showTransactions(state.wallet[0].id);
            }
        }

        function addCard() {
            const no = document.getElementById('card-no').value;
            const pass = document.getElementById('card-pass').value;
            const bal = document.getElementById('card-balance').value;
            const imgBase64 = document.getElementById('card-img-base64').value;
            const imgUrl = document.getElementById('card-img-url').value;
            
            if(no.length !== 19 || isNaN(no)) return alert('卡号必须是19位数字');
            if(!pass || !bal) return alert('请填写完整');
            
            const newCard = {
                id: Date.now(), no, pass, 
                bal: parseFloat(bal),
                img: imgBase64 || imgUrl || '',
                transactions: [ { title: '开卡奖励', time: new Date().toLocaleDateString(), amount: '+10.00' } ]
            };
            newCard.bal += 10.00;
            state.wallet.push(newCard);
            store.set('wallet', state.wallet);
            closeModal('modal-card-add');
            renderWallet();
        }

        function showTransactions(cardId) {
            activeCardId = cardId;
            const card = state.wallet.find(c => c.id === cardId);
            if(!card) return;
            const container = document.getElementById('wallet-transactions');
            container.innerHTML = card.transactions.slice().reverse().map(t => `
                <div class="trans-item">
                    <div class="trans-info">
                        <div>${t.title}</div>
                        <div>${t.time}</div>
                    </div>
                    <div class="trans-amount" style="color: ${t.amount.startsWith('+') ? '#4caf50' : '#333'}">${t.amount}</div>
                </div>
            `).join('');
        }

        // 钱包卡片点击逻辑：单击查看，双击操作
        let cardClickTimer = null;
        function handleCardClick(id) {
            if (cardClickTimer) {
                clearTimeout(cardClickTimer);
                cardClickTimer = null;
                // Double Click
                activeCardId = id;
                document.getElementById('overlay-mask').style.display = 'block';
                document.getElementById('sheet-card-actions').classList.add('show');
            } else {
                cardClickTimer = setTimeout(() => {
                    // Single Click
                    showTransactions(id);
                    cardClickTimer = null;
                }, 250);
            }
        }

        function cardAction(type) {
            closeAllActionSheets();
            const card = state.wallet.find(c => c.id === activeCardId);
            if(!card) return;
            if(type === 'delete') {
                if(confirm('确定删除这张卡片吗？')) {
                    state.wallet = state.wallet.filter(c => c.id !== activeCardId);
                    store.set('wallet', state.wallet);
                    renderWallet();
                }
            } else if(type === 'recharge') {
                const amount = prompt('输入充值金额:');
                if(amount && !isNaN(amount)) {
                    const val = parseFloat(amount);
                    card.bal += val;
                    card.transactions.push({ title: '余额充值', time: new Date().toLocaleString(), amount: '+' + val.toFixed(2) });
                    store.set('wallet', state.wallet);
                    renderWallet();
                }
            }
        }

        // --- 聊天详情页转账 ---
        function openTransferModal() {
            if(state.wallet.length === 0) return alert('请先去钱包添加卡片');
            const select = document.getElementById('transfer-card-select');
            select.innerHTML = state.wallet.map(c => `<option value="${c.id}">尾号${c.no.slice(-4)} (余额: ${c.bal.toFixed(2)})</option>`).join('');
            document.getElementById('modal-transfer').classList.add('show');
        }

        function confirmTransfer() {
            const cardId = parseInt(document.getElementById('transfer-card-select').value);
            const amount = parseFloat(document.getElementById('transfer-amount').value);
            const pass = document.getElementById('transfer-pass').value;
            const card = state.wallet.find(c => c.id === cardId);
            if(!card) return;
            if(pass !== card.pass) return alert('支付密码错误');
            if(amount > card.bal) return alert('余额不足');
            if(amount <= 0 || isNaN(amount)) return alert('金额无效');

            card.bal -= amount;
            card.transactions.push({ title: '转账支出', time: new Date().toLocaleString(), amount: '-' + amount.toFixed(2) });
            store.set('wallet', state.wallet);

            if(!state.chats[currentChatCharId]) state.chats[currentChatCharId] = [];
            state.chats[currentChatCharId].push({ role: 'user', type: 'transfer', content: `转账 ¥${amount.toFixed(2)}`, amount: amount.toFixed(2) });
            store.set('chats', state.chats);
            closeModal('modal-transfer');
            renderChatMessages();
            scrollToBottom();
            renderWallet();
        }

        // --- 聊天功能 ---
        let currentChatCharId = null;

        function renderChatList() {
            const container = document.getElementById('chat-list-container');
            const chatIds = Object.keys(state.chats);
            if(chatIds.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding: 50px; color:#aaa;">暂无聊天，去通讯录发起</div>';
                return;
            }
            const listHtml = chatIds.map(charId => {
                const char = state.characters.find(c => c.id === charId);
                if(!char) return null;
                const history = state.chats[charId];
                let lastMsg = "点击进入聊天...";
                if(history.length > 0) {
                    const m = history[history.length - 1];
                    lastMsg = m.type === 'image' ? '[图片]' : (m.type === 'transfer' ? '[转账]' : m.content);
                }
                return `
                    <div class="chat-item" onclick="openChatWindow('${char.id}')">
                        <img src="${char.avatar}" class="avatar">
                        <div class="chat-info">
                            <div class="chat-name">${char.name}</div>
                            <div class="chat-preview">${lastMsg}</div>
                        </div>
                    </div>
                `;
            }).filter(i => i).join('');
            container.innerHTML = listHtml || '<div style="text-align:center; padding: 50px; color:#aaa;">暂无聊天</div>';
        }

        function openChatWindow(charId) {
            currentChatCharId = charId;
            const char = state.characters.find(c => c.id === charId);
            document.getElementById('current-chat-title').innerText = char.name;
            document.getElementById('chat-window').classList.add('open');
            document.getElementById('expand-panel').classList.remove('show');
            cancelQuote(); 
            renderChatMessages();
            scrollToBottom();
        }

        function closeChatWindow() {
            document.getElementById('chat-window').classList.remove('open');
            renderChatList();
            currentChatCharId = null;
        }

        function scrollToBottom() {
            setTimeout(() => {
                const container = document.getElementById('current-chat-messages');
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        function renderChatMessages() {
            if(!currentChatCharId) return;
            const history = state.chats[currentChatCharId] || [];
            const container = document.getElementById('current-chat-messages');
            const char = state.characters.find(c => c.id === currentChatCharId);
            const userAvatar = state.config.myAvatar || 'https://ui-avatars.com/api/?name=Me';

            container.innerHTML = history.map((msg, idx) => {
                if(msg.type === 'revoked') {
                    return `
                        <div class="msg-row ${msg.role === 'user' ? 'user' : 'ai'}" onclick="alert('撤回的内容: ${msg.original}')">
                            ${msg.role === 'assistant' ? `<img src="${char.avatar}" class="avatar" style="width:35px;height:35px;margin-right:10px;">` : `<img src="${userAvatar}" class="avatar">`}
                            <div class="msg-bubble revoked">消息已撤回 (点击查看)</div>
                        </div>`;
                }
                if(msg.type === 'transfer') {
                    return `
                        <div class="msg-row user" onclick="handleMsgClick(${idx}, '${msg.role}')" oncontextmenu="return false;">
                            <img src="${userAvatar}" class="avatar">
                            <div class="msg-bubble transfer">
                                <div class="transfer-icon"><i class="fas fa-check-circle"></i> 转账成功</div>
                                <div class="transfer-amount">¥ ${msg.amount}</div>
                            </div>
                        </div>`;
                }
                return `
                <div class="msg-row ${msg.role === 'user' ? 'user' : 'ai'}" onclick="handleMsgClick(${idx}, '${msg.role}')" oncontextmenu="return false;">
                    ${msg.role === 'assistant' 
                        ? `<img src="${char.avatar}" class="avatar" style="width:35px;height:35px;margin-right:10px;">` 
                        : `<img src="${userAvatar}" class="avatar">` 
                    }
                    <div style="display:flex; flex-direction:column; align-items:${msg.role==='user'?'flex-end':'flex-start'};">
                        ${msg.quote ? `<div style="font-size:10px; color:#999; margin-bottom:2px; background:#eee; padding:2px 5px; border-radius:4px;">引用: ${msg.quote}</div>` : ''}
                        <div class="msg-bubble">${msg.content}</div>
                    </div>
                </div>
            `}).join('');
        }

        // 消息气泡点击逻辑：双击触发菜单
        let msgClickTimer = null;
        function handleMsgClick(idx, role) {
            if(msgClickTimer) {
                clearTimeout(msgClickTimer);
                msgClickTimer = null;
                // Double Click
                activeMsgId = idx;
                document.getElementById('overlay-mask').style.display = 'block';
                document.getElementById('sheet-msg-actions').classList.add('show');
                document.getElementById('action-regenerate').style.display = (role === 'assistant') ? 'block' : 'none';
            } else {
                msgClickTimer = setTimeout(() => { msgClickTimer = null; }, 250);
            }
        }
        
        function closeAllActionSheets() {
            document.querySelectorAll('.action-sheet').forEach(el => el.classList.remove('show'));
            document.getElementById('overlay-mask').style.display = 'none';
        }

        function msgAction(action) {
            closeAllActionSheets();
            const history = state.chats[currentChatCharId];
            if(!history || activeMsgId === null) return;
            const msg = history[activeMsgId];

            if(action === 'delete') {
                history.splice(activeMsgId, 1);
                store.set('chats', state.chats);
                renderChatMessages();
            }
            else if(action === 'revoke') {
                const originalContent = msg.content;
                msg.type = 'revoked';
                msg.original = originalContent;
                msg.content = "消息已撤回";
                store.set('chats', state.chats);
                renderChatMessages();
            }
            else if(action === 'edit') {
                const newText = prompt("编辑消息:", msg.content);
                if(newText) {
                    msg.content = newText;
                    store.set('chats', state.chats);
                    renderChatMessages();
                }
            }
            else if(action === 'quote') {
                currentQuote = msg.content;
                document.getElementById('quote-text').innerText = currentQuote.substring(0, 20) + (currentQuote.length>20?'...':'');
                document.getElementById('quote-preview').classList.add('show');
            }
            else if(action === 'regenerate') {
                history.splice(activeMsgId, 1);
                store.set('chats', state.chats);
                renderChatMessages();
                triggerAIResponse();
            }
        }

        function cancelQuote() {
            currentQuote = null;
            document.getElementById('quote-preview').classList.remove('show');
        }

        // --- 发送逻辑 ---
        function sendUserMessage() {
            const input = document.getElementById('msg-input');
            const content = input.value.trim();
            if(!content || !currentChatCharId) return;

            if(!state.chats[currentChatCharId]) state.chats[currentChatCharId] = [];
            
            const newMsg = { role: 'user', content };
            if(currentQuote) {
                newMsg.quote = currentQuote;
                cancelQuote();
            }
            
            state.chats[currentChatCharId].push(newMsg);
            store.set('chats', state.chats);
            input.value = '';
            renderChatMessages();
            scrollToBottom();
        }

        async function triggerAIResponse() {
            if(!currentChatCharId) return;
            const char = state.characters.find(c => c.id === currentChatCharId);
            const history = state.chats[currentChatCharId];
            
            const validHistory = history.map(m => {
                if(m.type === 'revoked') return { role: m.role, content: "[User revoked a message]" };
                if(m.type === 'transfer') return { role: m.role, content: `[User transferred ¥${m.amount}]` };
                return { role: m.role, content: m.content };
            });

            // 获取全局世界书
            const globalWI = state.worldInfo.filter(wi => wi.scope === 'global');
            // 获取角色专属世界书
            const charWI = state.worldInfo.filter(wi => wi.scope === currentChatCharId);
            
            const wiText = [...globalWI, ...charWI].map(wi => `<entry key="${wi.keyword}" group="${wi.group||''}">${wi.content}</entry>`).join('\n');
            
            // 提示词：强制要求读取人设、全局WI、角色WI
            const systemPrompt = `
                【Instructions】
                You must strictly follow the character persona and read all World Info provided below.
                
                【World Info (Global & Character Specific)】
                ${wiText}
                
                【Character Persona】
                Name: ${char.name}
                Description: ${char.prompt}
                
                Instruction: Roleplay as ${char.name}. Stay in character. Respond in the language of the user. Be concise.
                If you see "[User revoked a message]", it means the user deleted something.
            `;

            const messages = [
                { role: 'system', content: systemPrompt },
                ...validHistory.slice(-10) 
            ];

            const msgContainer = document.getElementById('current-chat-messages');
            const loadingId = 'loading-' + Date.now();
            msgContainer.innerHTML += `<div id="${loadingId}" class="msg-row ai"><div class="msg-bubble">...</div></div>`;
            scrollToBottom();

            try {
                const response = await fetch(`${state.config.url}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${state.config.key}` },
                    body: JSON.stringify({ model: state.config.model, messages: messages })
                });

                const data = await response.json();
                document.getElementById(loadingId).remove();

                if(data.error) {
                    alert('API Error: ' + data.error.message);
                    return;
                }

                const aiContent = data.choices[0].message.content;
                state.chats[currentChatCharId].push({ role: 'assistant', content: aiContent });
                store.set('chats', state.chats);
                renderChatMessages();
                scrollToBottom();

            } catch (e) {
                document.getElementById(loadingId).remove();
                alert('网络错误: ' + e.message);
            }
        }

        // --- 朋友圈评论长按删除 ---
        function handleCommentLongPress(postId, commentIdx) {
            longPressTimer = setTimeout(() => {
                if(confirm('删除这条评论?')) {
                    const post = state.posts.find(p => p.id === postId);
                    if(post && post.comments) {
                        post.comments.splice(commentIdx, 1);
                        store.set('posts', state.posts);
                        renderMoments();
                    }
                }
            }, 600);
        }
        function cancelLongPress() { clearTimeout(longPressTimer); }

        // --- 其他工具函数 ---
        function toggleExpandPanel() { document.getElementById('expand-panel').classList.toggle('show'); scrollToBottom(); }
        function closeFullPage(id) { document.getElementById(id).classList.remove('open'); }
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }
        
        function jumpToChatList(charId) {
            if (!state.chats[charId]) { state.chats[charId] = []; store.set('chats', state.chats); }
            switchTab('chat');
        }
        function handleTouchStart(id) {
            longPressTimer = setTimeout(() => {
                if(confirm('编辑或删除角色？\n确定=编辑，取消=删除。')) {
                    const char = state.characters.find(c => c.id === id);
                    document.getElementById('char-id').value = char.id;
                    document.getElementById('char-name').value = char.name;
                    document.getElementById('char-prompt').value = char.prompt;
                    document.getElementById('char-avatar-preview').src = char.avatar;
                    document.getElementById('modal-character').classList.add('show');
                } else {
                    if(confirm('确定删除该角色？')) {
                        state.characters = state.characters.filter(c => c.id !== id);
                        store.set('chars', state.characters);
                        renderContacts();
                    }
                }
            }, 800);
        }
        
        // --- 朋友圈渲染 ---
        function renderMoments() {
            const container = document.getElementById('moments-feed');
            container.innerHTML = state.posts.map(post => `
                <div class="post-card">
                    <div class="post-header">
                        <img src="${post.avatar}" class="avatar" style="border-radius:4px;">
                        <div style="margin-left:10px;">
                            <div style="font-weight:bold; color:#576b95;">${post.user}</div>
                            <div style="font-size:12px; color:#ccc;">${post.time}</div>
                        </div>
                    </div>
                    <div class="post-content" style="margin-left:60px;">
                        <div class="post-text">${post.content}</div>
                        ${post.img ? `<img src="${post.img}" style="max-width:100%; border-radius:8px; margin-bottom:10px;">` : ''}
                        
                        <div class="post-actions">
                            <span onclick="toggleLikePost(${post.id})">
                                <i class="${post.isLiked ? 'fas fa-heart liked' : 'far fa-heart'}"></i> 
                                ${post.likes || 0}
                            </span>
                            <span onclick="commentPost(${post.id})"><i class="far fa-comment"></i> 评论</span>
                        </div>
                        
                        ${post.comments.length > 0 ? `
                        <div class="post-comments">
                            ${post.comments.map((c, idx) => `
                                <div class="comment-item" onclick="replyComment(${post.id}, '${c.user}')" ontouchstart="handleCommentLongPress(${post.id}, ${idx})" ontouchend="cancelLongPress()" oncontextmenu="return false;">
                                    <span style="color:#576b95; font-weight:bold;">${c.user}:</span> ${c.text}
                                </div>
                            `).join('')}
                        </div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function openPostModal() { document.getElementById('modal-post').classList.add('show'); }
        function publishPost() {
            const content = document.getElementById('post-content').value;
            const img = document.getElementById('post-img-base64').value;
            if(!content) return;
            const newPost = { id: Date.now(), user: state.user.name, avatar: state.config.myAvatar || 'https://ui-avatars.com/api/?name=Me', content, img, likes: 0, isLiked: false, comments: [], time: new Date().toLocaleString() };
            state.posts.unshift(newPost); store.set('posts', state.posts); closeModal('modal-post'); renderMoments();
        }
        function toggleLikePost(id) {
            const post = state.posts.find(p => p.id === id);
            if(post) { post.isLiked ? (post.likes--, post.isLiked=false) : (post.likes++, post.isLiked=true); store.set('posts', state.posts); renderMoments(); }
        }
        function commentPost(id) {
            const text = prompt("输入评论:");
            if(text) { const post = state.posts.find(p => p.id === id); if(post) { post.comments.push({ user: state.user.name, text }); store.set('posts', state.posts); renderMoments(); } }
        }
        function replyComment(postId, targetUser) {
            const text = prompt(`回复 @${targetUser}:`);
            if(text) { const post = state.posts.find(p => p.id === postId); if(post) { post.comments.push({ user: state.user.name, text: `回复 @${targetUser}: ${text}` }); store.set('posts', state.posts); renderMoments(); } }
        }

        async function fetchModels() {
            const url = document.getElementById('api-url').value;
            const key = document.getElementById('api-key').value;
            if(!url || !key) return alert('请先填写 URL 和 Key');
            try {
                const res = await fetch(`${url}/models`, { headers: { 'Authorization': `Bearer ${key}` } });
                const data = await res.json();
                const list = data.data.map(m => m.id);
                state.config.url = url; state.config.key = key; state.config.modelList = list;
                store.set('config', state.config);
                const select = document.getElementById('model-select');
                select.innerHTML = list.map(m => `<option value="${m}">${m}</option>`).join('');
                alert('模型列表已更新');
            } catch(e) { alert('获取失败: ' + e.message); }
        }
        document.getElementById('model-select').addEventListener('change', (e) => { state.config.model = e.target.value; store.set('config', state.config); });
        
        // 通讯录和世界书相关
        function openAddCharacterModal() { document.getElementById('char-avatar-preview').src = 'https://ui-avatars.com/api/?background=random'; document.getElementById('modal-character').classList.add('show'); }
        function saveCharacter() { 
            const id = document.getElementById('char-id').value || Date.now().toString();
            const name = document.getElementById('char-name').value;
            const prompt = document.getElementById('char-prompt').value;
            const avatar = document.getElementById('char-avatar-preview').src;
            if(!name) return alert('名字不能为空');
            const existingIdx = state.characters.findIndex(c => c.id === id);
            const newChar = { id, name, avatar, prompt };
            if(existingIdx > -1) state.characters[existingIdx] = newChar; else state.characters.push(newChar);
            store.set('chars', state.characters); closeModal('modal-character'); renderContacts();
        }
        function openWorldInfoModal() { document.getElementById('modal-worldinfo').classList.add('show'); }
        
        function saveWorldInfo() { 
            const keyword = document.getElementById('wi-keyword').value;
            const content = document.getElementById('wi-content').value;
            const scope = document.getElementById('wi-scope').value;
            const group = document.getElementById('wi-group').value.trim(); // 获取分组
            if(!keyword || !content) return;
            state.worldInfo.push({ id: Date.now(), keyword, content, scope, group }); 
            store.set('worldInfo', state.worldInfo); 
            closeModal('modal-worldinfo'); 
            renderWorldInfoList();
        }

        function renderWorldInfoList() { 
            const container = document.getElementById('world-info-list');
            
            // 分组逻辑
            const groups = {};
            const ungrouped = [];
            
            state.worldInfo.forEach(wi => {
                if(wi.group) {
                    if(!groups[wi.group]) groups[wi.group] = [];
                    groups[wi.group].push(wi);
                } else {
                    ungrouped.push(wi);
                }
            });

            let html = '';

            // 渲染分组 (白色条目)
            for (const gName in groups) {
                html += `<div class="wi-group-item" ondblclick="openWiGroupDetail('${gName}')">
                            <span><i class="fas fa-folder" style="color:#aaa;margin-right:5px;"></i> ${gName}</span>
                            <span style="font-size:10px; color:#aaa;">${groups[gName].length}条</span>
                         </div>`;
            }

            // 渲染未分组
            html += '<div style="display:flex; flex-wrap:wrap;">';
            ungrouped.forEach(wi => {
                const scopeName = wi.scope === 'global' ? '全局' : (state.characters.find(c=>c.id === wi.scope)?.name || '未知');
                html += `<div class="capsule active" onclick="deleteWorldInfo(${wi.id})">${scopeName}: ${wi.keyword} <i class="fas fa-times" style="margin-left:5px;"></i></div>`;
            });
            html += '</div>';

            container.innerHTML = html;
        }

        // 打开分组详情
        function openWiGroupDetail(groupName) {
            const list = state.worldInfo.filter(w => w.group === groupName);
            const container = document.getElementById('wi-group-list');
            document.getElementById('wi-group-title').innerText = `分组: ${groupName}`;
            
            container.innerHTML = list.map(wi => {
                const scopeName = wi.scope === 'global' ? '全局' : (state.characters.find(c=>c.id === wi.scope)?.name || '未知');
                return `<div class="capsule active" onclick="deleteWorldInfo(${wi.id})">${scopeName}: ${wi.keyword} <i class="fas fa-times" style="margin-left:5px;"></i></div>`;
            }).join('');
            
            document.getElementById('modal-wi-group-view').classList.add('show');
        }

        function deleteWorldInfo(id) { 
            if(confirm("删除这条世界书设定？")) { 
                state.worldInfo = state.worldInfo.filter(w => w.id !== id); 
                store.set('worldInfo', state.worldInfo); 
                renderWorldInfoList(); 
                // 如果在分组视图中，也刷新它
                if(document.getElementById('modal-wi-group-view').classList.contains('show')) {
                    const currentTitle = document.getElementById('wi-group-title').innerText.replace('分组: ', '');
                    openWiGroupDetail(currentTitle);
                }
            } 
        }
        function renderContacts() { 
            const container = document.getElementById('contacts-container');
            container.innerHTML = state.characters.map(char => `
                <div class="contact-card" onclick="jumpToChatList('${char.id}')" ontouchstart="handleTouchStart('${char.id}')" ontouchend="cancelLongPress()" oncontextmenu="return false;">
                    <img src="${char.avatar}" class="avatar">
                    <div class="contact-info">
                        <div style="font-weight:bold;">${char.name}</div>
                        <div class="contact-tag">AI Character</div>
                    </div>
                </div>
            `).join('');
            const wiSelect = document.getElementById('wi-scope');
            wiSelect.innerHTML = `<option value="global">全局 (所有角色)</option>` + state.characters.map(c => `<option value="${c.id}">仅: ${c.name}</option>`).join('');
        }

        init();
    </script>
</body>
</html>